Float32Array=Float32Array||Array;requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame;
var SOAR={PIMUL2:2*Math.PI,PIDIV2:Math.PI/2,DEGRAD:Math.PI/180,RADDEG:180/Math.PI,KEY:{TAB:9,ENTER:13,SPACE:32,ESCAPE:27,LEFTARROW:37,UPARROW:38,RIGHTARROW:39,DOWNARROW:40,SHIFT:16,CTRL:17,ALT:18,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,ZERO:48,ONE:49,TWO:50,THREE:51,FOUR:52,FIVE:53,SIX:54,SEVEN:55,EIGHT:56,NINE:57},lastFrame:(new Date).getTime(),interval:0,elapsedTime:0,fpsCount:0,fpsTime:(new Date).getTime(),
fps:0,running:!0,action:[],run:function(){var a,c;if(this.running){a=(new Date).getTime();c=a-this.lastFrame;this.fpsCount++;1E3<=a-this.fpsTime&&(this.fps=this.fpsCount,this.fpsCount=0,this.fpsTime=a);500>c&&(this.interval=c);this.lastFrame=a;this.elapsedTime+=this.interval;for(a=this.action.length-1;0<=a;a--)c=this.action[a],c.active&&this.elapsedTime-c.timestamp>c.period&&(c.func(),c.repeat?c.timestamp=this.elapsedTime:c.active=!1)}requestAnimationFrame?requestAnimationFrame(function(){SOAR.run()}):
setTimeout(function(){SOAR.run()},1E3/60)},schedule:function(a,c,b){this.action.push({func:a,period:c,repeat:b,timestamp:this.elapsedTime,active:!0});return this.action.length-1},unschedule:function(a){this.action[a].active=!1},reschedule:function(a){this.action[a].active=!0},togglePause:function(){this.running=!this.running},extend:function(a,c){for(p in c)c.hasOwnProperty(p)&&(a[p]=c[p])},chain:function(a,c){var b=Object.create(a);SOAR.extend(b,c);return b},textOf:function(a){return document.getElementById(a).innerHTML},
loadResources:function(a,c,b){var d,e,g=0,f=0,b=b||function(){};if(!c)throw"SOAR.loadResources requires oncomplete event handler.";for(d in a)if(a.hasOwnProperty(d)&&(e=a[d],f++,"image"===e.type&&(e.data=new Image,e.data.addEventListener("load",function(){g++;b(g,f);g===f&&c()})),"sound"===e.type))e.data=new Audio,e.data.addEventListener("canplaythrough",function(){g++;b(g,f);g===f&&c()});for(d in a)a.hasOwnProperty(d)&&(e=a[d],e.data.src=e.path)},getImageData:function(a,c){var b=document.createElement("canvas"),
c=c||{},d=c.x||0,e=c.y||0,g=c.w||a.width,f=c.h||a.height;b.context=b.getContext("2d");b.width=g;b.height=f;b.context.drawImage(a,0,0);return b.context.getImageData(d,e,g,f)},sign:function(a){return 0<a?1:0>a?-1:0},clamp:function(a,c,b){return Math.min(Math.max(a,c),b)},subdivide:function(a,c,b,d,e,g){function f(a,b,c,d,e,k,n){var o,q,r,s,t,u;0===a?g(b,c,d,e,k,n):(o=0.5*(b+d),q=0.5*(c+e),r=0.5*(k+d),s=0.5*(n+e),t=0.5*(b+k),u=0.5*(c+n),a--,f(a,b,c,o,q,t,u),f(a,o,q,d,e,r,s),f(a,t,u,r,s,k,n),f(a,r,s,
t,u,o,q))}f(a,c,b,c,e,d,e);f(a,c,b,d,e,d,b)},vector:{create:function(a,c,b){var d=Object.create(SOAR.vector);d.set(a,c,b);return d},set:function(a,c,b){this.x=a||0;this.y=c||0;this.z=b||0;return this},copy:function(a){this.x=a.x;this.y=a.y;this.z=a.z;return this},add:function(a){this.x+=a.x;this.y+=a.y;this.z+=a.z;return this},sub:function(a){this.x-=a.x;this.y-=a.y;this.z-=a.z;return this},mul:function(a){this.x*=a;this.y*=a;this.z*=a;return this},div:function(a){a?(this.x/=a,this.y/=a,this.z/=a):
this.set(0,0,0);return this},neg:function(){return this.set(-this.x,-this.y,-this.z)},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},distance:function(a){var c=this.x-a.x,b=this.y-a.y,a=this.z-a.z;return Math.sqrt(c*c+b*b+a*a)},distsqrd:function(a){var c=this.x-a.x,b=this.y-a.y,a=this.z-a.z;return c*c+b*b+a*a},norm:function(){return this.div(this.length())},dot:function(a){return this.x*a.x+this.y*a.y+this.z*a.z},cross:function(a){var c=this.x,b=this.y,d=this.z;this.x=
b*a.z-d*a.y;this.y=d*a.x-c*a.z;this.z=c*a.y-b*a.x;return this},toArray:function(a){a=a||[];a[0]=this.x;a[1]=this.y;a[2]=this.z;return a},nearest:function(a,c){c=c||Math.round;this.x=c(this.x/a)*a;this.y=c(this.y/a)*a;this.z=c(this.z/a)*a;return this}},quaternion:{create:function(a,c,b,d){var e=Object.create(SOAR.quaternion);e.set(a,c,b,d);return e},set:function(a,c,b,d){this.x=a||0;this.y=c||0;this.z=b||0;this.w=d||0;return this},copy:function(a){this.x=a.x;this.y=a.y;this.z=a.z;this.w=a.w;return this},
mul:function(a){var c=this.x,b=this.y,d=this.z,e=this.w;this.x=e*a.x+c*a.w+b*a.z-d*a.y;this.y=e*a.y+b*a.w+d*a.x-c*a.z;this.z=e*a.z+d*a.w+c*a.y-b*a.x;this.w=e*a.w-c*a.x-b*a.y-d*a.z;return this},neg:function(){return this.set(-this.x,-this.y,-this.z,this.w)},norm:function(){var a=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);return this.set(this.x/a,this.y/a,this.z/a,this.w)},toArray:function(a){a=a||[];a[0]=this.x;a[1]=this.y;a[2]=this.z;a[3]=this.w;return a},toMatrix:function(a){a=
a||[];a[0]=1-2*(this.y*this.y+this.z*this.z);a[1]=2*(this.x*this.y+this.z*this.w);a[2]=2*(this.x*this.z-this.y*this.w);a[3]=0;a[4]=2*(this.x*this.y-this.z*this.w);a[5]=1-2*(this.x*this.x+this.z*this.z);a[6]=2*(this.z*this.y+this.x*this.w);a[7]=0;a[8]=2*(this.x*this.z+this.y*this.w);a[9]=2*(this.y*this.z-this.x*this.w);a[10]=1-2*(this.x*this.x+this.y*this.y);a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1;return a},setFromAxisAngle:function(a,c,b,d){var e=Math.sin(d/2);return this.set(a*e,c*e,b*e,Math.cos(d/
2))}},freeRotor:{create:function(){var a=Object.create(SOAR.freeRotor);a.rotation=SOAR.quaternion.create(0,0,0,1);a.orientation={right:SOAR.vector.create(),up:SOAR.vector.create(),front:SOAR.vector.create()};a.spinquat={x:SOAR.quaternion.create(),y:SOAR.quaternion.create(),z:SOAR.quaternion.create(),q:SOAR.quaternion.create()};a.matrix={transpose:new Float32Array(16),rotations:new Float32Array(16)};a.turn(0,0,0);return a},turn:function(a,c,b){var d=this.spinquat,e=this.orientation,g=this.matrix.rotations,
f=this.matrix.transpose;d.x.setFromAxisAngle(1,0,0,a);d.y.setFromAxisAngle(0,1,0,c);d.z.setFromAxisAngle(0,0,1,b);d.q.copy(d.x).mul(d.y).mul(d.z);this.rotation.mul(d.q).norm();this.rotation.toMatrix(g);e.right.set(g[0],g[4],g[8]);e.up.set(g[1],g[5],g[9]);e.front.set(g[2],g[6],g[10]).neg();f.set(g);f[1]=g[4];f[4]=g[1];f[2]=g[8];f[8]=g[2];f[6]=g[9];f[9]=g[6]}}};
SOAR.boundRotor={PITCH_LIMIT:Math.sqrt(2)/2,create:function(){var a=Object.create(SOAR.boundRotor);a.rotation=SOAR.quaternion.create(0,0,0,1);a.pitch=SOAR.quaternion.create(0,0,0,1);a.yaw=SOAR.quaternion.create(0,0,0,1);a.orientation={right:SOAR.vector.create(),up:SOAR.vector.create(),front:SOAR.vector.create()};a.scratch={pitch:SOAR.quaternion.create(),check:SOAR.quaternion.create(),yaw:SOAR.quaternion.create()};a.matrix={transpose:new Float32Array(16),rotations:new Float32Array(16)};a.turn(0,0,
0);return a},turn:function(a,c){var b=this.orientation,d=this.matrix.rotations,e=this.matrix.transpose;this.scratch.pitch.setFromAxisAngle(1,0,0,c);this.scratch.check.copy(this.pitch).mul(this.scratch.pitch);this.scratch.check.norm();this.scratch.check.w>=this.PITCH_LIMIT&&this.pitch.copy(this.scratch.check);this.scratch.yaw.setFromAxisAngle(0,1,0,a);this.yaw.mul(this.scratch.yaw);this.yaw.norm();this.rotation.set(0,0,0,1);this.rotation.mul(this.pitch).mul(this.yaw);this.rotation.norm();this.rotation.toMatrix(d);
b.right.set(d[0],d[4],d[8]);b.up.set(d[1],d[5],d[9]);b.front.set(d[2],d[6],d[10]).neg();e.set(d);e[1]=d[4];e[4]=d[1];e[2]=d[8];e[8]=d[2];e[6]=d[9];e[9]=d[6]}};
SOAR.random={create:function(a){var c=Object.create(SOAR.random);c.reseed(a);c.modu=Math.pow(2,32);return c},iterate:function(){this.seed=(1664525*this.seed+1013904223)%this.modu},get:function(){this.iterate();return this.seed/this.modu},getl:function(){this.iterate();return this.seed},getn:function(a){return a*this.get()},getm:function(a){return 2*a*this.get()-a},reseed:function(a){this.seed=a||(new Date).getTime()}};
SOAR.interpolator={linear:function(a,c,b){return a*(1-b)+c*b},cosine:function(a,c,b){b=(1-Math.cos(b*Math.PI))/2;return a*(1-b)+c*b}};
SOAR.noise1D={create:function(a,c,b,d){var e=Object.create(SOAR.noise1D),a=SOAR.random.create(a);e.interpolate=SOAR.interpolator.cosine;e.size=b;e.period=d;e.amplitude=c;e.map=new Float32Array(b);for(c=0;c<b;c++)e.map[c]=a.get();return e},get:function(a){var a=this.period*Math.abs(a),c=Math.floor(a);return this.amplitude*this.interpolate(this.map[c%this.size],this.map[(c+1)%this.size],a-c)}};
SOAR.noise2D={create:function(a,c,b,d,e,g){var f=Object.create(SOAR.noise2D),a=SOAR.random.create(a);f.interpolate=SOAR.interpolator.cosine;f.xSize=b;f.ySize=e||b;f.xPeriod=d;f.yPeriod=g||d;f.amplitude=c;f.map=new Float32Array(f.xSize*f.ySize);c=0;for(b=f.map.length;c<b;c++)f.map[c]=a.get();return f},get:function(a,c){var b=this.xPeriod*Math.abs(a),d=Math.floor(b),b=b-d,e=this.yPeriod*Math.abs(c),g=Math.floor(e),e=e-g,f=d%this.xSize,h=g%this.ySize,d=(d+1)%this.xSize,g=(g+1)%this.ySize,f=this.interpolate(this.map[f+
h*this.xSize],this.map[f+g*this.xSize],e),e=this.interpolate(this.map[d+h*this.xSize],this.map[d+g*this.xSize],e);return this.amplitude*this.interpolate(f,e,b)}};
SOAR.noise3D={create:function(a,c,b,d,e,g,f,h){var i=Object.create(SOAR.noise3D),a=SOAR.random.create(a);i.interpolate=SOAR.interpolator.cosine;i.xSize=b;i.ySize=e||b;i.zSize=f||e||b;i.xPeriod=d;i.yPeriod=g||d;i.zPeriod=h||g||d;i.amplitude=c;i.map=new Float32Array(i.xSize*i.ySize*i.zSize);c=0;for(b=i.map.length;c<b;c++)i.map[c]=a.get();return i},get:function(a,c,b){var a=this.xPeriod*Math.abs(a),d=Math.floor(a),a=a-d,c=this.yPeriod*Math.abs(c),e=Math.floor(c),c=c-e,b=this.zPeriod*Math.abs(b),g=Math.floor(b),
b=b-g,f=d%this.xSize,h=e%this.ySize,i=g%this.zSize,d=(d+1)%this.xSize,e=(e+1)%this.ySize,g=(g+1)%this.zSize,j,l,m,k=this.xSize*this.ySize;j=this.map[f+h*this.xSize+i*k];l=this.map[f+h*this.xSize+g*k];j=this.interpolate(j,l,b);l=this.map[f+e*this.xSize+i*k];m=this.map[f+e*this.xSize+g*k];l=this.interpolate(l,m,b);f=this.interpolate(j,l,c);j=this.map[d+h*this.xSize+i*k];l=this.map[d+h*this.xSize+g*k];j=this.interpolate(j,l,b);l=this.map[d+e*this.xSize+i*k];m=this.map[d+e*this.xSize+g*k];l=this.interpolate(l,
m,b);c=this.interpolate(j,l,c);return this.amplitude*this.interpolate(f,c,a)}};
SOAR.camera={FREE_ROTATION:0,BOUND_ROTATION:1,viewAngle:30,nearLimit:0.5,farLimit:1E3,create:function(a,c){var b;if(!a)throw"SOAR.camera.create requires display object.";c=c||SOAR.camera.FREE_ROTATION;switch(c){case SOAR.camera.FREE_ROTATION:b=SOAR.freeRotor.create();break;case SOAR.camera.BOUND_ROTATION:b=SOAR.boundRotor.create()}b=SOAR.chain(b,SOAR.camera);b.matrix.projector=new Float32Array(16);b.matrix.modelview=new Float32Array(16);b.position=SOAR.vector.create();b.display=a;b.gl=a.gl;return b},
rotations:function(){return this.matrix.rotations},transpose:function(){return this.matrix.transpose},projector:function(){var a=this.matrix.projector,c,b,d;c=this.display.width/this.display.height;b=1/Math.tan(this.viewAngle*SOAR.DEGRAD);d=this.nearLimit-this.farLimit;a[0]=b/c;a[1]=a[2]=a[3]=0;a[5]=b;a[4]=a[6]=a[7]=0;a[10]=(this.farLimit+this.nearLimit)/d;a[8]=a[9]=0;a[11]=-1;a[14]=2*this.nearLimit*this.farLimit/d;a[12]=a[13]=a[15]=0;return a},modelview:function(){var a=this.position,c=this.matrix.modelview,
b=this.matrix.rotations;c.set(b);c[12]=-(b[0]*a.x+b[4]*a.y+b[8]*a.z);c[13]=-(b[1]*a.x+b[5]*a.y+b[9]*a.z);c[14]=-(b[2]*a.x+b[6]*a.y+b[10]*a.z);c[3]=c[7]=c[11]=0;c[15]=1;return c}};
SOAR.mesh={STARTING_LENGTH:256,create:function(a,c){var b,d;if(!a)throw"SOAR.mesh.create requires display object.";d=a.gl;b=Object.create(SOAR.mesh);b.data=new Float32Array(this.STARTING_LENGTH);b.drawPrimitive=c||d.TRIANGLES;b.length=0;b.drawCount=0;b.stride=0;b.buffer=null;b.attribute=[];b.display=a;b.gl=d;return b},add:function(a,c){var b,d;this.attribute.push({index:a,size:c});b=this.stride=0;for(d=this.attribute.length;b<d;b++)this.stride+=this.attribute[b].size},grow:function(a){var a=this.length+
a,c,b;if(a>this.data.length){a=Math.pow(2,Math.ceil(Math.log(a)/Math.LN2));a=new Float32Array(a);c=0;for(b=this.length;c<b;c++)a[c]=this.data[c];this.data=a}},set:function(){var a,c=arguments.length;this.grow(c);for(a=0;a<c;a++)this.data[this.length++]=arguments[a]},load:function(a){var c,b,d;this.grow(a.length);c=this.length;b=0;for(d=this.length+a.length;c<d;c++,b++)this.data[c]=a[b];this.length=d},reset:function(){this.length=0},release:function(){this.gl.deleteBuffer(this.buffer);this.buffer=
null},build:function(a,c){var b=this.gl,d=c?b.DYNAMIC_DRAW:b.STATIC_DRAW;null!=this.buffer&&b.deleteBuffer(this.buffer);this.buffer=b.createBuffer();b.bindBuffer(b.ARRAY_BUFFER,this.buffer);b.bufferData(b.ARRAY_BUFFER,this.data,d);this.drawCount=Math.ceil(this.length/this.stride);a||delete this.data},draw:function(a,c){var b=this.gl,d,e,g,f,a=a||0,c=c||this.drawCount;b.bindBuffer(b.ARRAY_BUFFER,this.buffer);d=f=0;for(e=this.attribute.length;d<e;d++)g=this.attribute[d],b.enableVertexAttribArray(g.index),
b.vertexAttribPointer(g.index,g.size,b.FLOAT,!1,this.stride*Float32Array.BYTES_PER_ELEMENT,f*Float32Array.BYTES_PER_ELEMENT),f+=g.size;b.drawArrays(this.drawPrimitive,a,c);d=0;for(e=this.attribute.length;d<e;d++)b.disableVertexAttribArray(this.attribute[d].index)},append:function(a,c){var b,d,e,g,f=0,h=this.stride-1;e=this.length;this.grow(a.length);b=0;for(d=a.length;b<d;b++)g=a.data[b],c&&(0===f&&(g+=c.x),1===f&&(g+=c.y),2===f&&(g+=c.z)),this.data[e+b]=g,f=f<h?f+1:0;this.length+=a.length},modify:function(a,
c){var b=this.gl;b.bindBuffer(b.ARRAY_BUFFER,this.buffer);b.bufferSubData(b.ARRAY_BUFFER,a,c)}};
SOAR.shader={create:function(a,c,b,d,e,g){var f,h,i,j;if(!a)throw"SOAR.shader.create requires display object.";d=d||[];e=e||[];g=g||[];h=a.gl;f=h.createShader(h.VERTEX_SHADER);h.shaderSource(f,c);h.compileShader(f);if(!h.getShaderParameter(f,h.COMPILE_STATUS))throw console.log(h.getShaderInfoLog(f)),"SOAR.shader.create couldn't compile vertex shader";c=h.createShader(h.FRAGMENT_SHADER);h.shaderSource(c,b);h.compileShader(c);if(!h.getShaderParameter(c,h.COMPILE_STATUS))throw console.log(h.getShaderInfoLog(c)),
"SOAR.shader.create couldn't compile fragment shader";b=h.createProgram();h.attachShader(b,f);h.attachShader(b,c);h.linkProgram(b);if(!h.getProgramParameter(b,h.LINK_STATUS))throw console.log(h.getProgramInfoLog(b)),"SOAR.shader.create couldn't link shader program";j=Object.create(SOAR.shader);j.program=b;f=0;for(c=d.length;f<c;f++)i=d[f],j[i]=h.getAttribLocation(b,i);f=0;for(c=e.length;f<c;f++)i=e[f],j[i]=h.getUniformLocation(b,i);f=0;for(c=g.length;f<c;f++)i=g[f],j[i]=h.getUniformLocation(b,i);
j.display=a;j.gl=h;return j},activate:function(){this.gl.useProgram(this.program)},release:function(){var a=this.gl,c=a.getAttachedShaders(this.program),b,d;b=0;for(d=c.length;b<d;b++)a.detachShader(this.program,c[b]),a.deleteShader(c[b]);a.deleteProgram(this.program);delete this.program}};
SOAR.texture={create:function(a,c,b){var d;if(!a)throw"SOAR.texture.create requires display object.";d=Object.create(SOAR.texture);d.display=a;d.gl=a.gl;b&&(c=SOAR.getImageData(c,b));a=d.gl;b=a.createTexture();a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.bindTexture(a.TEXTURE_2D,b);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,c);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR_MIPMAP_LINEAR);a.generateMipmap(a.TEXTURE_2D);
a.bindTexture(a.TEXTURE_2D,null);d.data=b;return d},bind:function(a,c){var b=this.gl;b.uniform1i(c,a);b.activeTexture(b.TEXTURE0+a);b.bindTexture(b.TEXTURE_2D,this.data)},release:function(){this.gl.deleteTexture(this.data);delete this.data}};
SOAR.display={create:function(a,c){var b=Object.create(SOAR.display);b.canvas=document.getElementById(a);if(!b.canvas)throw"SOAR.display.create couldn't create canvas object.";try{b.gl=b.canvas.getContext("experimental-webgl",{alpha:c})}catch(d){try{b.gl=b.canvas.getContext("webgl",{alpha:c})}catch(e){throw"SOAR.display.create couldn't get WebGL context.";}}if(!b.gl)throw"SOAR.display.create couldn't get WebGL context.";return b},setSize:function(a,c){this.width=a;this.height=c;this.canvas.width=
a;this.canvas.height=c;this.gl.viewport(0,0,a,c)}};
var EASY={resources:{noise1:{type:"image",path:"res/noise1.jpg"},noise2:{type:"image",path:"res/noise2.jpg"},oil:{type:"image",path:"res/oil.png"},coin:{type:"image",path:"res/change.gif"},wood:{type:"image",path:"res/chest.gif"},bricks:{type:"image",path:"res/bricks.jpg"},corpse:{type:"image",path:"res/corpse.jpg"}},START_BLURB:'<p>Easy Does It<br>By Chris Gauthier<br>wordsaretoys.com</p><p class="small">Easy, the fabled adventurer, leaves a path of devastation through an underground ruin.</p><p class="small">He\'s got no time to make amends&mdash;that\'s <em>your</em> job.</p><p class="small">Dispose of his victims, calm their angry spirits,<br>appease their gods, and make a little money.</p><p class="small"><em>Very</em> little money.</p><p>Press Enter to Play</p></div>',END_BLURB:"<p>Press F5 to Play Again</p>",
I:new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),LAST_GENERATION:15,updating:!0,generation:0,start:function(){var a;try{EASY.display=SOAR.display.create("gl")}catch(c){jQuery("#glerror").show();return}Array.prototype.pick=function(){return this[Math.floor(Math.random()*this.length)]};Array.prototype.shuffle=function(){var a=this.length,c,e;if(0!=a)for(;--a;)c=Math.floor(Math.random()*(a+1)),e=this[a],this[a]=this[c],this[c]=e};EASY.display.setSize(document.body.clientWidth,document.body.clientHeight);
a=EASY.display.gl;a.clearDepth(1);a.depthFunc(a.LEQUAL);a.enable(a.DEPTH_TEST);EASY.texture={};EASY.texture.canvas=document.createElement("canvas");EASY.texture.canvas.width=256;EASY.texture.canvas.height=256;EASY.texture.context=EASY.texture.canvas.getContext("2d");EASY.hud.init();EASY.hud.setCurtain(0.9);EASY.hud.setMessage(EASY.hud.waitMsg);SOAR.loadResources(EASY.resources,function(){EASY.cave.process();EASY.trash.process();EASY.ghost.process();EASY.corpse.process();EASY.generate();SOAR.schedule(EASY.update,
0,!0);SOAR.schedule(EASY.draw,0,!0);window.addEventListener("resize",function(){EASY.display.setSize(document.body.clientWidth,document.body.clientHeight);EASY.draw()},!1);EASY.hud.setMessage(EASY.START_BLURB);SOAR.run()},function(a,c){var e=Math.round(90*a/c);EASY.hud.setMessage(EASY.hud.waitMsg+"<br>"+e+"%")});EASY.cave.init();EASY.player.init();EASY.trash.init();EASY.ghost.init();EASY.corpse.init()},generate:function(){var a=!0;this.generation++;do EASY.cave.generate(),a=EASY.corpse.generate(),
EASY.ghost.generate(),a=a&&EASY.trash.generate(),EASY.player.generate();while(!a)},update:function(){EASY.updating&&(EASY.player.update(),EASY.trash.update(),EASY.ghost.update(),EASY.corpse.update())},draw:function(){var a=EASY.display.gl;a.clearColor(0,0,0,1);a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT);EASY.hideCave||EASY.cave.draw();EASY.player.camera.mapView?EASY.player.draw():(EASY.trash.draw(),EASY.corpse.draw(),EASY.ghost.draw())},isTheEnd:function(){return this.generation===this.LAST_GENERATION},
end:function(){EASY.hud.setCurtain(0.5);EASY.hud.setMessage(this.END_BLURB);SOAR.running=!1;EASY.hud.dom.window.unbind("keydown");EASY.hud.dom.window.unbind("keyup");EASY.hud.dom.tracker.unbind()},canvasser:{RED:0,GREEN:1,BLUE:2,create:function(a,c,b,d,e){var g=Object.create(EASY.canvasser);g.canvas=document.createElement("canvas");g.context=g.canvas.getContext("2d");g.canvas.width=c;g.canvas.height=d||c;g.scale={x:b,y:e||b};g.interpolate=SOAR.interpolator.cosine;g.amplitude=a;return g},build:function(a,
c,b,d){this.map=this.context.getImageData(a||0,c||0,b||this.canvas.width,d||this.canvas.height)},get:function(a,c,b){var d=this.map.width,e=this.map.height,g=this.map.data,c=this.scale.x*Math.abs(c),f=Math.floor(c),c=c-f,b=this.scale.y*Math.abs(b),h=Math.floor(b),b=b-h,i=SOAR.clamp(f,0,d-1),j=SOAR.clamp(h,0,e-1),f=SOAR.clamp(f+1,0,d-1),e=SOAR.clamp(h+1,0,e-1),h=this.interpolate(g[4*(i+j*d)+a]/256,g[4*(i+e*d)+a]/256,b),a=this.interpolate(g[4*(f+j*d)+a]/256,g[4*(f+e*d)+a]/256,b);return this.amplitude*
this.interpolate(h,a,c)}},hud:{COMMENT_FADE_TIME:250,COMMENT_READ_TIME:4E3,pauseMsg:"Press Esc To Resume",waitMsg:"Loading",starting:!0,init:function(){this.dom={window:jQuery(window),comment:jQuery("#comment"),tracker:jQuery("#tracker"),message:jQuery("#message"),prompts:jQuery("#prompts"),readout:jQuery("#readout"),legend:jQuery("#legend"),collect:{oil:jQuery("#oil"),wood:jQuery("#wood"),coin:jQuery("#coin")},will:jQuery("#will"),maxWill:jQuery("#max-will"),luck:jQuery("#luck")};this.dom.prompts.shown=
!1;this.dom.prompts.resize=function(){var a=EASY.hud.dom.prompts;a.offset({top:0.75*(EASY.display.height-a.height()),left:0.5*(EASY.display.width-a.width())})};this.dom.window.bind("keydown",this.onKeyDown);this.dom.window.bind("resize",this.resize);this.resize();this.dom.message.bind("mousedown",function(){return!1})},resize:function(){var a=EASY.hud.dom;a.tracker.width(EASY.display.width);a.tracker.height(EASY.display.height);a.message.offset({top:0.5*(EASY.display.height-a.message.height()),left:0.5*
(EASY.display.width-a.message.width())});a.prompts.resize()},onKeyDown:function(a){if(EASY.hud.starting)return a.keyCode===SOAR.KEY.ENTER&&(EASY.hud.dom.legend.show(),EASY.hud.dom.readout.show(),EASY.hud.lighten(),EASY.player.mouse.invalid=!0,EASY.hud.starting=!1),!0;switch(a.keyCode){case SOAR.KEY.ESCAPE:SOAR.running?(EASY.hud.setMessage(EASY.hud.pauseMsg),EASY.hud.setCurtain(0.5),SOAR.running=!1):(EASY.hud.lighten(),SOAR.running=!0,EASY.player.mouse.invalid=!0);break;case SOAR.KEY.TAB:return!1;
case SOAR.KEY.E:if(EASY.hud.dom.prompts.shown)switch(EASY.hud.dom.prompts.action){case "cremate":EASY.player.cremate()}}return!0},setCurtain:function(a){this.dom.tracker.css("background-color","rgba(0, 0, 0, "+a+")")},setMessage:function(a){this.dom.message.html(a||"");this.resize()},darken:function(){this.setCurtain(0.5);this.setMessage(this.waitMsg)},lighten:function(){this.setCurtain(0);this.setMessage()},comment:function(a,c){var b=jQuery(document.createElement("div")),d="<span>"+("player"===
c?"Me":"Ghost of "+EASY.corpse.identity)+"</span><br>"+a;b.addClass(c);b.html(d);b.css("display","none");this.dom.comment.append(b);b.fadeTo(this.COMMENT_FADE_TIME,0.75).delay(this.COMMENT_READ_TIME).hide(this.COMMENT_FADE_TIME,function(){b.remove()})},showPrompt:function(a,c,b,d){var e=this.dom.prompts;e.shown||(e.html('<p><span class="key">'+a+"</span>&nbsp;"+c+"</p><p>"+b+"</p>"),e.resize(),e.css("visibility","visible"),e.shown=!0,e.action=d)},hidePrompt:function(){var a=this.dom.prompts;a.shown&&
(a.css("visibility","hidden"),a.shown=!1)},setCollection:function(a,c){var b=this.dom.collect[a],d=parseInt(b.html(),10);c!==d&&(b.html(c),b.fadeTo(50,0).fadeTo(50,1).fadeTo(50,0).fadeTo(50,1).fadeTo(50,0).fadeTo(50,1))},setWill:function(a,c){var b=parseInt(this.dom.will.html(),10);a!==b&&(this.dom.will.html(a),this.dom.will.fadeTo(50,0).fadeTo(50,1).fadeTo(50,0).fadeTo(50,1).fadeTo(50,0).fadeTo(50,1));b=parseInt(this.dom.maxWill.html(),10);c!==b&&(this.dom.maxWill.html(c),this.dom.maxWill.fadeTo(50,
0).fadeTo(50,1).fadeTo(50,0).fadeTo(50,1).fadeTo(50,0).fadeTo(50,1))},setLuck:function(a){var c=parseInt(this.dom.luck.html(),10),a=Math.round(100*a);a!==c&&(this.dom.luck.html(a),this.dom.luck.fadeTo(50,0).fadeTo(50,1).fadeTo(50,0).fadeTo(50,1).fadeTo(50,0).fadeTo(50,1))}}};
EASY.player={SPIN_RATE:0.007,NORMAL_SPEED:4,SPRINT_SPEED:10,HEIGHT:1.5,SYMPATHY_LOSS:0.3,COMMENTS:{trash:{wood:"Easy's not the most patient man when it comes to treasure.;Looks like <em>someone</em> forgot to bring his lockpicks again.;Another wooden box that'll never again mock a stupid adventurer.;Who needs skill and craft when you've got a short temper?;Poor little treasure chest. Must have set him off somehow.;It's amazing what a massive iron battleaxe will do to rotten wood.;Someday, I'll find a chest Easy hasn't smashed to bits.;Easy failed Lockpicking 101, but he found a way to deal with it.;Ancient locksmiths put all their ingenuity into this pile of splinters.;When the only tool you have is an axe, every problem ends up in pieces.".split(";"),oil:["Another sample of Easy's extra smoky lamp oil.",
"Guess who can't figure out a simple light spell?","Whoops. Almost slipped in that.","The great adventurers swear by Leakey Oil Lamps."],coin:"A few moldy pennies make the terror worthwhile.;Nice of him to leave me a pittance.;Hey, look what rolled out of Easy's pocket.;That's almost a million gold. Very, very almost.;I've nearly saved enough for a new bootlace.;I see that Sir has left his usual 0.01% gratuity.;Coins. Why didn't the old kings hoard land deeds?".split(";")},attack:{excuse:"You can't expect good behavior from a treasure-seeker.;Shadowy ruins? Poor lighting? Accidents happen.;These spooky passages would make anyone axe-happy.;Once Easy smells gold, he's no longer in control.;Easy has an expensive lifestyle to maintain.;Easy was in full compliance with his personal Code of Conduct.;Easy was merely upholding the standards of his profession.;You can't blame a man for not knowing how to love.".split(";"),
appease:"I can see you have valid complaints.,You have good reason to be annoyed.,I accept that being killed wasn't in your best interest.,Naturally you weren't expecting a major life change today.,Of <em>course</em> I'd be upset in your position.,I concede that the system failed you in this instance.,I understand you're going through a difficult transition.,Your needs weren't fully anticipated by our organization.".split(","),flatter:"You look good in ectoplasm.{<em>Un</em>dead? Now there's a can-do attitude.{Ghostliness is next to godliness.{Even a gory death couldn't slow you down.{It takes a lot of courage to start over.{You make a windy, echoing moan sound good.{Poise and dignity. Poise&mdash;and <em>dignity</em>.{What excellent taste in apparitions.{You've made me see death in a whole new light.".split("{"),
notready:"...wait, it'll come to me...;...I had a good one, hold on...;...my mind's a blank right now...;...oh look, rocks...;...uh, okay, maybe not...;...hang on, hang on...;...got this song in my head...;...er, just a second...".split(";"),notarget:["What, am I talking to <em>myself</em> now?","Why? No one can hear me.","Nothing to say and no one to say it to.","Nobody's listening."]},cremate:{notcalm:["I have to deal with the ghost first.","See that angry ghost? One thing at a time."],nowood:["I don't have enough wood for kindling.",
"Blood-soaked cloth doesn't burn well. I need more wood."],nooil:["I don't have enough oil for the anointing.","Got to grease that corpse up first. I need more oil."]}},headPosition:SOAR.vector.create(),footPosition:SOAR.vector.create(),velocity:SOAR.vector.create(),trash:{wood:0,oil:0,coin:0},delay:0,maxWill:10,will:0,luck:0.5,sympathy:{snark:0,scare:0,shame:0,normalize:function(){var a=this.snark+this.scare+this.shame;this.snark/=a;this.scare/=a;this.shame/=a}},motion:{moveleft:!1,moveright:!1,
movefore:!1,moveback:!1},mouse:{down:!1,x:0,y:0,invalid:!0},scratch:{direction:SOAR.vector.create(),velocity:SOAR.vector.create(),matrix:new Float32Array(16)},sprint:!1,init:function(){var a=this,c=this.dom={tracker:jQuery("#tracker"),window:jQuery(window)};c.window.bind("keydown",this.onKeyDown);c.window.bind("keyup",this.onKeyUp);c.tracker.bind("mousedown",this.onMouseDown);c.tracker.bind("mouseup",this.onMouseUp);c.tracker.bind("mousemove",this.onMouseMove);this.eyeview=SOAR.camera.create(EASY.display,
SOAR.camera.BOUND_ROTATION);this.eyeview.nearLimit=0.01;this.eyeview.farLimit=100;this.eyeview.mapView=!1;this.overhead=SOAR.camera.create(EASY.display,SOAR.camera.FREE_ROTATION);this.overhead.nearLimit=1;this.overhead.farLimit=500;this.overhead.position.set(0.5*EASY.cave.LENGTH,75,0.5*EASY.cave.LENGTH);this.overhead.turn(SOAR.PIDIV2,0,0);this.overhead.mapView=!0;this.camera=this.eyeview;this.sympathy.shame=Math.random();this.sympathy.scare=Math.random();this.sympathy.snark=Math.random();this.sympathy.normalize();
this.shader=SOAR.shader.create(EASY.display,SOAR.textOf("vs-item"),SOAR.textOf("fs-item"),["position","texturec"],["projector","modelview","rotations","center"],["sign"]);this.mesh=SOAR.mesh.create(EASY.display);this.mesh.add(this.shader.position,3);this.mesh.add(this.shader.texturec,2);SOAR.subdivide(0,-0.5,-0.5,0.5,0.5,function(b,c,e,g,f,h){a.mesh.set(b,0,c,b+0.5,c+0.5);a.mesh.set(e,0,g,e+0.5,g+0.5);a.mesh.set(f,0,h,f+0.5,h+0.5)});this.mesh.build();(function(){var b=EASY.texture.context,c=EASY.texture.canvas.width,
e=EASY.texture.canvas.height;b.clearRect(0,0,c,e);b.fillStyle="rgb(255, 255, 255)";b.strokeStyle="rgb(0, 0, 0)";b.lineWidth=3;b.beginPath();b.moveTo(c/2,e);b.lineTo(0,0);b.lineTo(c/2,e/4);b.lineTo(c,0);b.lineTo(c/2,e);b.fill();b.stroke();a.texture=SOAR.texture.create(EASY.display,b.getImageData(0,0,c,e))})();SOAR.schedule(function(){a.will<a.maxWill&&EASY.ghost.mode!==EASY.ghost.ATTACKING&&(a.will++,EASY.hud.setWill(a.will,a.maxWill))},1E3,!0)},generate:function(){var a,c;a=EASY.cave.area[0].x;c=
EASY.cave.LENGTH-2;this.footPosition.set(a,EASY.cave.getFloorHeight(a,c),c);this.camera.yaw.set(0,0,0,1);this.camera.turn(0,0,0);this.will=this.maxWill;EASY.hud.setWill(this.will,this.maxWill);EASY.hud.setLuck(this.luck)},update:function(){var a=0.001*SOAR.interval,c=this.sprint?this.SPRINT_SPEED:this.NORMAL_SPEED,b=this.scratch,d=this.motion,e=this.camera;this.nextMap&&(EASY.generate(),EASY.hud.lighten(),delete this.nextMap);b.direction.set();d.movefore&&b.direction.add(e.orientation.front);d.moveback&&
b.direction.sub(e.orientation.front);d.moveleft&&b.direction.sub(e.orientation.right);d.moveright&&b.direction.add(e.orientation.right);b.direction.norm();this.velocity.x=b.direction.x*c;this.velocity.y-=9.81*a;this.velocity.z=b.direction.z*c;this.constrainVelocity(this.footPosition,this.velocity);b.velocity.copy(this.velocity).mul(a);this.footPosition.add(b.velocity);this.constrainPosition(this.footPosition);this.headPosition.copy(this.footPosition);this.headPosition.y+=this.HEIGHT;e.position.copy(this.headPosition);
0<this.delay&&(this.delay=Math.max(0,this.delay-a))},constrainVelocity:function(a,c){var b=this.scratch.direction;a.y===EASY.cave.getFloorHeight(a.x,a.z)&&(c.y=0<c.y?c.y:0);b.set(EASY.cave.getFloorHeight(a.x-1,a.z)-EASY.cave.getFloorHeight(a.x+1,a.z),0,EASY.cave.getFloorHeight(a.x,a.z-1)-EASY.cave.getFloorHeight(a.x,a.z+1)).set(Math.pow(b.x,2)*SOAR.sign(b.x),0,Math.pow(b.z,2)*SOAR.sign(b.z));c.add(b);a.y>=EASY.cave.WALL_HEIGHT-this.HEIGHT-0.5&&(c.x=b.x,c.z=b.z)},constrainPosition:function(a){var c=
EASY.cave.getFloorHeight(a.x,a.z);a.y<c&&(a.y=c);0>=a.z&&this.exitCave();a.z>EASY.cave.LENGTH-2&&(a.z=EASY.cave.LENGTH-2)},onKeyDown:function(a){var c=EASY.player,b=c.motion;if(EASY.hud.starting)return!0;switch(a.keyCode){case SOAR.KEY.A:b.moveleft=!0;break;case SOAR.KEY.D:b.moveright=!0;break;case SOAR.KEY.W:b.movefore=!0;break;case SOAR.KEY.S:b.moveback=!0;break;case SOAR.KEY.SHIFT:c.sprint=!0;break;case SOAR.KEY.Q:c.camera=c.overhead;EASY.updating=!1;break;case SOAR.KEY.ONE:c.attack("excuse");
break;case SOAR.KEY.TWO:c.attack("appease");break;case SOAR.KEY.THREE:c.attack("flatter")}return!0},onKeyUp:function(a){var c=EASY.player,b=c.motion;if(EASY.hud.starting)return!0;switch(a.keyCode){case SOAR.KEY.A:b.moveleft=!1;break;case SOAR.KEY.D:b.moveright=!1;break;case SOAR.KEY.W:b.movefore=!1;break;case SOAR.KEY.S:b.moveback=!1;break;case SOAR.KEY.SHIFT:c.sprint=!1;break;case SOAR.KEY.Q:c.camera=c.eyeview,EASY.updating=!0,c.mouse.invalid=!0}return!0},onMouseDown:function(){EASY.player.mouse.down=
!0;return!1},onMouseUp:function(){return EASY.player.mouse.down=!1},onMouseMove:function(a){var c=EASY.player,b,d;c.mouse.down&&!c.camera.mapView&&SOAR.running&&!c.mouse.invalid&&(b=c.SPIN_RATE*(a.pageX-c.mouse.x),d=c.SPIN_RATE*(a.pageY-c.mouse.y),c.camera.turn(b,d));c.mouse.x=a.pageX;c.mouse.y=a.pageY;return c.mouse.invalid=!1},collect:function(a){var c=a.object,a=a.number,b=EASY.ghost;b.mode!==b.ATTACKING&&!EASY.isTheEnd()&&EASY.hud.comment(this.COMMENTS.trash[c].pick(),"player");this.trash[c]=
(this.trash[c]||0)+a;EASY.hud.setCollection(c,this.trash[c])},attack:function(a){EASY.isTheEnd()||(EASY.ghost.mode!==EASY.ghost.ATTACKING?EASY.hud.comment(this.COMMENTS.attack.notarget.pick(),"player"):0<this.delay?EASY.hud.comment(this.COMMENTS.attack.notready.pick(),"player"):(EASY.hud.comment(this.COMMENTS.attack[a].pick(),"player"),(a=EASY.ghost.defend(a))?this.delay=1+Math.random():EASY.ghost.mode===EASY.ghost.BECALMED&&(this.maxWill++,this.will=this.maxWill,EASY.hud.setWill(this.will,this.maxWill))))},
defend:function(a){var c=this.sympathy[a],b;return this.luck*Math.random()<c?(b=Math.ceil(c*EASY.ghost.will),this.will=Math.max(0,this.will-b),EASY.hud.setWill(this.will,this.maxWill),0===this.will&&EASY.ghost.concede(),this.sympathy[a]=c*(1-this.SYMPATHY_LOSS),this.sympathy.normalize(),!1):!0},cremate:function(){var a=EASY.corpse,c=EASY.ghost,b=EASY.hud;c.mode===c.ATTACKING?b.comment(this.COMMENTS.cremate.notcalm.pick(),"player"):this.trash.wood<a.wood?b.comment(this.COMMENTS.cremate.nowood.pick(),
"player"):this.trash.oil<a.oil?b.comment(this.COMMENTS.cremate.nooil.pick(),"player"):(this.trash.wood-=a.wood,b.setCollection("wood",this.trash.wood),this.trash.oil-=a.oil,b.setCollection("oil",this.trash.oil),a.cremate(),EASY.isTheEnd()||(this.luck+=0.01,b.setLuck(this.luck)))},exitCave:function(){EASY.isTheEnd()?EASY.end():(EASY.hud.darken(),this.nextMap=!0)},draw:function(){var a=EASY.display.gl,c=this.shader,b;a.enable(a.BLEND);a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA);c.activate();a.uniformMatrix4fv(c.projector,
!1,this.camera.projector());a.uniformMatrix4fv(c.modelview,!1,this.camera.modelview());b=this.eyeview;b.yaw.w=-b.yaw.w;b.yaw.toMatrix(this.scratch.matrix);b.yaw.w=-b.yaw.w;a.uniformMatrix4fv(c.rotations,!1,this.scratch.matrix);b=this.headPosition;a.uniform3f(c.center,b.x,b.y,b.z);this.texture.bind(0,c.sign);this.mesh.draw();a.disable(a.BLEND)}};
EASY.cave={LENGTH:64,STEP:0.35,EDGE:8,ZERO_HEIGHT:0.5,WALL_HEIGHT:4,SEPARATION:1,MAX_AREAS:7,texture:{},area:[],flat:[],init:function(){this.shader=SOAR.shader.create(EASY.display,SOAR.textOf("vs-cave"),SOAR.textOf("fs-cave"),["position","texturec"],["projector","modelview","color","torch"],["rock","brick"]);this.map=EASY.canvasser.create(this.WALL_HEIGHT,this.LENGTH,1);this.mesh=SOAR.mesh.create(EASY.display);this.mesh.add(this.shader.position,3);this.mesh.add(this.shader.texturec,2);this.palette=
[0.5,0.97,0.75,0.84,0.64,0.81,0.97,0.63,0.56];this.MIDDLE=this.WALL_HEIGHT-this.SEPARATION;this.CEILING=2*this.MIDDLE},process:function(){this.texture.noise=SOAR.texture.create(EASY.display,EASY.resources.noise1.data);this.texture.brick=SOAR.texture.create(EASY.display,EASY.resources.bricks.data)},generate:function(){var a=this.map,c=this.LENGTH,b=this.EDGE,d=c-b,e=this;a.context.fillStyle="rgb(255, 0, 0)";a.context.fillRect(0,0,c,c);(function(){var c;for(c=e.area.length=0;c<e.MAX_AREAS;c++)e.area[c]=
{x:b+(d-b)*Math.random(),y:b+(d-b)*Math.random()};e.area[0].y=d;e.area[e.MAX_AREAS-1].y=b;for(c=1;c<e.MAX_AREAS;c++){var f=e.area[c-1].x,h=e.area[c-1].y,i=e.area[c].x,j=e.area[c].y,l=void 0,m=void 0,k=void 0,n=void 0,o=void 0,n=i,o=j;do l=n-f,m=o-h,k=Math.sqrt(l*l+m*m),1<k&&(a.context.fillStyle="rgba(0, 0, 0, 0.25)",a.context.beginPath(),a.context.arc(f,h,2,0,SOAR.PIMUL2,!1),a.context.fill(),n=f,o=h,a.context.fillStyle="rgba(0, 0, 0, 0.01)"),l=Math.random()-Math.random(),m=Math.random()-Math.random(),
k=Math.sqrt(l*l+m*m),f+=0.5*l/k,h+=0.5*m/k,l=i-f,m=j-h,k=Math.sqrt(l*l+m*m),f+=0.1*l/k,h+=0.1*m/k,f=SOAR.clamp(f,b,d),h=SOAR.clamp(h,b,d),a.context.beginPath(),a.context.arc(f,h,2,0,SOAR.PIMUL2,!1),a.context.fill();while(1<k)}})();a.context.fillStyle="rgba(0, 0, 0, 0.75)";a.context.beginPath();a.context.arc(this.area[0].x,c-2,2,0,SOAR.PIMUL2,!1);a.context.arc(this.area[0].x,c-4,3,0,SOAR.PIMUL2,!1);a.context.arc(this.area[0].x,c-6,4,0,SOAR.PIMUL2,!1);a.context.arc(this.area[0].x,c-8,5,0,SOAR.PIMUL2,
!1);a.context.fill();a.context.beginPath();a.context.arc(this.area[this.MAX_AREAS-1].x,2,2,0,SOAR.PIMUL2,!1);a.context.arc(this.area[this.MAX_AREAS-1].x,4,3,0,SOAR.PIMUL2,!1);a.context.arc(this.area[this.MAX_AREAS-1].x,6,4,0,SOAR.PIMUL2,!1);a.context.arc(this.area[this.MAX_AREAS-1].x,8,5,0,SOAR.PIMUL2,!1);a.context.fill();a.build();this.mesh.reset();(function(){var a=e.STEP,b,d,i,j,l,m,k,n;for(b=0;b<c;b+=a)for(d=0;d<c;d+=a)i=b+a,j=d+a,l=e.getFloorHeight(b,d),m=e.getFloorHeight(i,d),k=e.getFloorHeight(b,
j),n=e.getFloorHeight(i,j),l>e.MIDDLE&&m>e.MIDDLE&&k>e.MIDDLE&&n>e.MIDDLE||(e.mesh.set(b,l,d,b,d),e.mesh.set(b,k,j,b,j),e.mesh.set(i,m,d,i,d),e.mesh.set(b,k,j,b,j),e.mesh.set(i,n,j,i,j),e.mesh.set(i,m,d,i,d),l=e.CEILING-l,m=e.CEILING-m,k=e.CEILING-k,n=e.CEILING-n,e.mesh.set(b,l,d,b,d),e.mesh.set(i,m,d,i,d),e.mesh.set(b,k,j,b,j),e.mesh.set(b,k,j,b,j),e.mesh.set(i,m,d,i,d),e.mesh.set(i,n,j,i,j))})();this.mesh.build(!0);(function(){var a=d-10,c,h;e.flat.length=0;for(c=b;c<d;c+=1.5)for(h=b;h<a;h+=1.5)e.isFlat(c,
h,0.5)&&e.flat.push({x:c,z:h});e.flat.shuffle()})()},getFloorHeight:function(a,c){return Math.max(this.ZERO_HEIGHT,Math.pow(this.map.get(0,a,c),1.1))},isFlat:function(a,c,b){return this.getFloorHeight(a,c)>this.ZERO_HEIGHT||this.getFloorHeight(a+b,c)>this.ZERO_HEIGHT||this.getFloorHeight(a-b,c)>this.ZERO_HEIGHT||this.getFloorHeight(a,c+b)>this.ZERO_HEIGHT||this.getFloorHeight(a,c-b)>this.ZERO_HEIGHT||this.getFloorHeight(a-b,c-b)>this.ZERO_HEIGHT||this.getFloorHeight(a-b,c+b)>this.ZERO_HEIGHT||this.getFloorHeight(a+
b,c-b)>this.ZERO_HEIGHT||this.getFloorHeight(a+b,c+b)>this.ZERO_HEIGHT?!1:!0},isOpen:function(a,c,b){var d=this.WALL_HEIGHT-this.SEPARATION-b;return this.getFloorHeight(a,c)>=d||this.getFloorHeight(a+b,c)>=d||this.getFloorHeight(a-b,c)>=d||this.getFloorHeight(a,c+b)>=d||this.getFloorHeight(a,c-b)>=d?!1:!0},draw:function(){var a=EASY.display.gl,c=EASY.player.camera,b=this.palette,d=this.shader;a.enable(a.CULL_FACE);a.cullFace(a.BACK);d.activate();a.uniformMatrix4fv(d.projector,!1,c.projector());a.uniformMatrix4fv(d.modelview,
!1,c.modelview());a.uniform3fv(d.color,b);a.uniform1i(d.torch,c.mapView?0:1);this.texture.noise.bind(0,d.rock);this.texture.brick.bind(1,d.brick);this.mesh.draw();a.disable(a.CULL_FACE)},release:function(){this.mesh.release();this.texture.noise.release()}};
EASY.trash={GRAB_DISTANCE:1.5,QUANT_MULTIPLE:3,ITEM:["wood","oil","coin"],list:[],texture:{},phase:0,init:function(){var a=this;this.shader=SOAR.shader.create(EASY.display,SOAR.textOf("vs-item"),SOAR.textOf("fs-item"),["position","texturec"],["projector","modelview","rotations","center"],["sign"]);this.mesh=SOAR.mesh.create(EASY.display);this.mesh.add(this.shader.position,3);this.mesh.add(this.shader.texturec,2);SOAR.subdivide(0,-0.5,-0.5,0.5,0.5,function(c,b,d,e,g,f){a.mesh.set(c,0,b,c+0.5,b+0.5);
a.mesh.set(d,0,e,d+0.5,e+0.5);a.mesh.set(g,0,f,g+0.5,f+0.5)});this.mesh.build()},process:function(){var a,c,b;a=0;for(c=this.ITEM.length;a<c;a++)b=this.ITEM[a],this.texture[b]=SOAR.texture.create(EASY.display,EASY.resources[b].data)},generate:function(){var a=EASY.cave.flat,c,b,d,e,g,f;this.list.length=0;if(EASY.isTheEnd()){e=a.pop();if(!e)return!1;this.list.push({center:SOAR.vector.create(e.x,EASY.cave.ZERO_HEIGHT+0.01,e.z),active:!0,object:"coin",number:9E3});return!0}c=1.5+0.5*Math.cos(this.phase);
g=0;for(f=this.ITEM.length;g<f;g++){b=Math.ceil(this.QUANT_MULTIPLE*c*(1+Math.random()));do{d=Math.ceil(b*Math.random());e=a.pop();if(!e)return!1;this.list.push({center:SOAR.vector.create(e.x,EASY.cave.ZERO_HEIGHT+0.01,e.z),active:!0,object:this.ITEM[g],number:d});b-=d}while(0<b)}this.phase+=Math.random();return!0},update:function(){var a=EASY.player.footPosition,c,b,d,e;c=0;for(b=this.list.length;c<b;c++)d=this.list[c],d.active&&(e=a.distance(d.center),e<this.GRAB_DISTANCE&&(d.active=!1,EASY.player.collect(d)))},
draw:function(){var a=EASY.display.gl,c=this.shader,b=EASY.player.camera,d,e,g;a.enable(a.BLEND);a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA);c.activate();a.uniformMatrix4fv(c.projector,!1,b.projector());a.uniformMatrix4fv(c.modelview,!1,b.modelview());a.uniformMatrix4fv(c.rotations,!1,EASY.I);d=0;for(e=this.list.length;d<e;d++)g=this.list[d],g.active&&(b=g.center,a.uniform3f(c.center,b.x,b.y,b.z),this.texture[g.object].bind(0,c.sign),this.mesh.draw());a.disable(a.BLEND)}};
EASY.ghost={SPEED:2.5,RADIUS:0.5,BUFFER_ZONE:4,SYMPATHY_LOSS:0.4,DORMANT:0,ATTACKING:1,BECALMED:2,ISEASY:3,COMMENTS:{attack:{scare:["What's that behind you? Oh, it's probably nothing.","Strange, how the walls seem to close in on you.","Words will not save you from what waits ahead.","I am not the only horror that prowls these ruins.","Not all shadows are merely the absence of light."],snark:["Do you enjoy working for a bloody-minded loon?","Some jobs even village idiots wouldn't do. You certainly showed them.",
"Whatever he's paying you, you're not worth it.","Perhaps you should have paid better attention in school."],shame:["I did nothing to provoke your master.","I meant no one any harm.","I died for no good reason.","I was struck down before I could utter a word."],calmed:["My soul rests. Not easily, but it will do.","Against my better judgement, I concede.","Fair enough.","I can argue no longer. Beaten again, it seems.","I yield. May your victory bring you joy."],disgust:["I want nothing more to do with you.",
"Enough. You mean nothing to me.","How insipid. Go away."]},awaken:["I see you, flesh.","Oh, look. After the lion, comes the mouse.","Hello, meat. I was just counting my organs.","Have you come to apologize? Too bad.","The worms already?"],release:"Farewell, o brave apologist.;You have the soul of a weasel, but there is some small good in you.;I pray I am as pleased to see the gods as they are to see me.;May you also find the release you seek.;I go to my reward. You must go to yours.;My spirit ascends. Yours remains. Beware.".split(";"),
alone:["Gone. How disappointing.","You reveal your true nature. I will pursue you no further.","Flee, then. Run forever."]},sympathy:{excuse:0,appease:0,flatter:0,normalize:function(){var a=this.excuse+this.appease+this.flatter;this.excuse/=a;this.appease/=a;this.flatter/=a}},phase:0,mode:0,will:0,alpha:0,delay:0,blink:0,lastAttack:{type:"scare",fail:!1},newAttack:{scare:["snark","shame"],snark:["scare","shame"],shame:["scare","snark"]},position:SOAR.vector.create(),velocity:SOAR.vector.create(),
target:SOAR.vector.create(),scratch:{pos:SOAR.vector.create(),dir:SOAR.vector.create()},texture:{},init:function(){var a=this;this.shader=SOAR.shader.create(EASY.display,SOAR.textOf("vs-ghost"),SOAR.textOf("fs-ghost"),["position","texturec"],"projector,modelview,rotations,center,time,alpha".split(","),["noise"]);this.mesh=SOAR.mesh.create(EASY.display);this.mesh.add(this.shader.position,3);this.mesh.add(this.shader.texturec,2);SOAR.subdivide(0,-0.5,-0.5,0.5,0.5,function(c,b,d,e,g,f){a.mesh.set(c,
b,0,c,b);a.mesh.set(d,e,0,d,e);a.mesh.set(g,f,0,g,f)});this.mesh.build()},process:function(){this.texture.noise=SOAR.texture.create(EASY.display,EASY.resources.noise2.data)},generate:function(){this.sympathy.excuse=Math.random();this.sympathy.appease=Math.random();this.sympathy.flatter=Math.random();this.sympathy.normalize();this.delay=1+Math.random();this.will=Math.round(1*EASY.player.maxWill);this.velocity.set();this.lastAttack.type="scare";this.lastAttack.fail=!1;this.suspend();this.mode=this.DORMANT;
EASY.isTheEnd()&&(this.mode=this.ISEASY,this.alpha=1,this.blink=Math.PI)},lookFor:function(a,c){var b=this.scratch.pos,d=this.scratch.dir,e=!0;b.copy(this.position);for(d.copy(a).sub(b).norm().mul(c);e&&(Math.abs(b.x-a.x)>c||Math.abs(b.z-a.z)>c);)b.add(d),e=EASY.cave.isOpen(b.x,b.z,c);return e},suspend:function(){this.position.copy(EASY.corpse.position).y=1+EASY.cave.getFloorHeight(this.position.x,this.position.z);this.alpha=0},update:function(){var a=EASY.player.footPosition,c=this.scratch.dir,b=
0.001*SOAR.interval,d;switch(this.mode){case this.DORMANT:a.distance(this.position)<this.BUFFER_ZONE&&(EASY.hud.comment(this.COMMENTS.awaken.pick(),"ghost"),this.target.copy(a),this.mode=this.ATTACKING);break;case this.ATTACKING:1>this.alpha&&(this.alpha=Math.min(1,this.alpha+b));0<this.blink&&(this.blink=Math.max(0,this.blink-4*b));0<this.delay?this.delay=Math.max(0,this.delay-b):this.attack();(d=this.lookFor(a,this.RADIUS))&&this.target.copy(a);a=c.copy(this.target).sub(this.position).length();
if(!d||a>this.BUFFER_ZONE)c.norm(),this.velocity.x=this.SPEED*c.x,this.velocity.z=this.SPEED*c.z,c.set(EASY.cave.getFloorHeight(this.position.x-1,this.position.z)-EASY.cave.getFloorHeight(this.position.x+1,this.position.z),0,EASY.cave.getFloorHeight(this.position.x,this.position.z-1)-EASY.cave.getFloorHeight(this.position.x,this.position.z+1)),this.velocity.add(c),this.position.add(this.velocity.mul(b)),this.position.y=EASY.cave.getFloorHeight(this.position.x,this.position.z)+1;!d&&1.1>a&&(EASY.hud.comment(this.COMMENTS.alone.pick(),
"ghost"),this.mode=this.DORMANT,this.suspend());break;case this.BECALMED:this.blink>-SOAR.PIDIV2?this.blink=Math.max(-SOAR.PIDIV2,this.blink-4*b):this.alpha=0}},draw:function(){var a=EASY.display.gl,c=this.shader,b=EASY.player.camera;a.enable(a.BLEND);a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA);c.activate();a.uniformMatrix4fv(c.projector,!1,b.projector());a.uniformMatrix4fv(c.modelview,!1,b.modelview());a.uniformMatrix4fv(c.rotations,!1,b.transpose());a.uniform3f(c.center,this.position.x,this.position.y,
this.position.z);a.uniform1f(c.time,SOAR.elapsedTime);b=1-Math.sin(this.blink)*Math.abs(Math.sin(8*this.blink));a.uniform1f(c.alpha,this.alpha*b);this.texture.noise.bind(0,c.noise);this.mesh.draw();a.disable(a.BLEND)},attack:function(){var a,c,b;c=this.lastAttack.type;b=this.lastAttack.fail;EASY.hud.comment(this.COMMENTS.attack[c].pick(),"ghost");a=EASY.player.defend(c);if((this.lastAttack.fail=a)&&b)this.lastAttack.type=this.newAttack[c].pick(),this.lastAttack.fail=!1;this.delay=1+Math.random()},
defend:function(a){var c=this.sympathy[a],b;return(1-EASY.player.luck)*Math.random()<c?(b=Math.ceil(c*EASY.player.will),this.will=Math.max(0,this.will-b),this.blink=Math.PI,0===this.will&&(this.mode=this.BECALMED,this.suspend(),EASY.hud.comment(this.COMMENTS.attack.calmed.pick(),"ghost")),this.sympathy[a]=c*(1-this.SYMPATHY_LOSS),this.sympathy.normalize(),!1):!0},concede:function(){this.suspend();this.mode=this.BECALMED;EASY.hud.comment(this.COMMENTS.attack.disgust.pick(),"ghost")},cremate:function(){this.mode===
this.BECALMED&&(this.alpha=1,this.blink=SOAR.PIDIV2,EASY.hud.comment(this.COMMENTS.release.pick(),"ghost"));this.mode===this.ISEASY&&(this.mode=this.BECALMED)}};
EASY.corpse={RADIUS:0.5,USE_RADIUS:2.5,BURN_TIME:5,PYRE_MULTIPLE:2.5,INTACT:0,BURNING:1,CREMATED:2,TITLE:["a Nameless Body","an Unknown Stiff","an Anonymous Corpse","a Forgotten Carcass"],identity:"",requires:"",texture:{},position:SOAR.vector.create(),mode:0,phase:Math.PI,wood:0,oil:0,change:0,scratch:{pos:SOAR.vector.create()},init:function(){var a=this;SOAR.vector.create();SOAR.noise2D.create(0,0.5,16,8);this.shader=SOAR.shader.create(EASY.display,SOAR.textOf("vs-corpse"),SOAR.textOf("fs-corpse"),
["position","texturec"],["projector","modelview","rotations","center","burn"],["body","ash"]);this.mesh=SOAR.mesh.create(EASY.display);this.mesh.add(this.shader.position,3);this.mesh.add(this.shader.texturec,2);SOAR.subdivide(4,-0.5,-1,0.5,1,function(c,b,d,e,g,f){var h=(0.25-d*d)*(1-e*e)-0.025,i=(0.25-g*g)*(1-f*f)-0.025;a.mesh.set(c,(0.25-c*c)*(1-b*b)-0.025,b,0.5+c,0.5*(b+1));a.mesh.set(d,h,e,0.5+d,0.5*(e+1));a.mesh.set(g,i,f,0.5+g,0.5*(f+1))});this.mesh.build()},process:function(){this.texture.body=
SOAR.texture.create(EASY.display,EASY.resources.corpse.data);this.texture.ash=SOAR.texture.create(EASY.display,EASY.resources.noise2.data)},generate:function(){var a;a=EASY.cave.flat.pop();if(!a)return!1;this.position.set(a.x,EASY.cave.ZERO_HEIGHT+0.01,a.z);a=1.5+0.5*Math.cos(this.phase);this.wood=Math.ceil(this.PYRE_MULTIPLE*a*(1+Math.random()));this.oil=Math.ceil(this.PYRE_MULTIPLE*a*(1+Math.random()));this.requires="Requires "+this.wood+" wood, "+this.oil+" oil ";this.phase+=Math.random();this.identity=
this.TITLE.pick();this.burn=0;this.mode=this.INTACT;EASY.isTheEnd()&&(this.identity="Easy",this.requires="",this.oil=this.wood=0);return!0},update:function(){var a=EASY.player.headPosition,c=a.distance(this.position),b=0;switch(this.mode){case this.INTACT:c<=this.USE_RADIUS&&(this.scratch.pos.copy(this.position).sub(a).norm(),b=this.USE_RADIUS*this.scratch.pos.dot(EASY.player.camera.orientation.front)/c);!EASY.hud.dom.prompts.shown&&1<b?EASY.hud.showPrompt("E","Cremate "+this.identity,this.requires,
"cremate"):EASY.hud.dom.prompts.shown&&1>=b&&EASY.hud.hidePrompt();break;case this.BURNING:this.burn=0.001*(SOAR.elapsedTime-this.timestamp)/this.BURN_TIME,1<=this.burn&&(this.burn=1,this.mode=this.CREMATED)}},cremate:function(){EASY.hud.hidePrompt();this.mode=this.BURNING;this.timestamp=SOAR.elapsedTime;EASY.ghost.cremate()},draw:function(){var a=EASY.display.gl,c=this.shader,b=EASY.player.camera,d=this.position;c.activate();a.uniformMatrix4fv(c.projector,!1,b.projector());a.uniformMatrix4fv(c.modelview,
!1,b.modelview());a.uniformMatrix4fv(c.rotations,!1,EASY.I);a.uniform3f(c.center,d.x,d.y,d.z);a.uniform1f(c.burn,this.burn);this.texture.body.bind(0,c.body);this.texture.ash.bind(1,c.ash);this.mesh.draw()}};
